FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    object      snappyHexMeshDict;
}

/*---------------------------------------------------------------------------*\
    The mesher cuts the 'city_buildings.stl' out of the blockMesh.
\*---------------------------------------------------------------------------*/

castellatedMesh true;
snap            true;
addLayers       true; // Adds prism layers for boundary layer resolution

geometry
{
    // STL lives in constant/geometry/
    constant/geometry/city_buildings.stl
    {
        type triSurfaceMesh;
        name buildings; 
    }
}

castellatedMeshControls
{
    maxGlobalCells 2000000; // Safety limit
    minRefinementCells 10;
    nCellsBetweenLevels 3;

    features
    (
        {
            file "constant/geometry/city_buildings.eMesh"; // Extracted edges for sharp corners
            level 3;
        }
    );

    refinementSurfaces
    {
        buildings
        {
            level (3 4); // Refine mesh level 3 min, 4 max near buildings
        }
    }

    resolveFeatureAngle 30;
    
    // IMPORTANT: Point inside the mesh but OUTSIDE the buildings
    // Adjust this coordinate to be in the air!
    locationInMesh (0 0 50); 
}

meshQualityControls
{
    maxNonOrtho         65;
    maxBoundarySkewness 20;
    maxInternalSkewness 4;
    maxConcave          80;
    minVol              1e-13;
    minTetQuality       1e-15;
    minArea             -1;
    minTwist            0.02;
    minDeterminant      0.001;
    minFaceWeight       0.02;
    minVolRatio         0.01;
    minTriangleTwist    -1;
    nSmoothScale        4;
    errorReduction      0.75;

    relaxed
    {
        maxNonOrtho 75;
    }
}

snapControls
{
    nSmoothPatch 3;
    tolerance 2.0;
    nSolveIter 30;
    nRelaxIter 5;
}

addLayersControls
{
    relativeSizes true;
    layers
    {
        buildings
        {
            nSurfaceLayers 3; // 3 layers of cells hugging the building
        }
        ground
        {
            nSurfaceLayers 2;
        }
    }
}
