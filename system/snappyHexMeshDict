FoamFile
{
    version     2.0;
    format      ascii;
    class       dictionary;
    object      snappyHexMeshDict;
}

/*---------------------------------------------------------------------------*\
    The mesher cuts the 'city_buildings.stl' out of the blockMesh.
\*---------------------------------------------------------------------------*/

castellatedMesh true;
snap            true;
addLayers       true; // Adds prism layers for boundary layer resolution

geometry
{
    // snappyHexMesh resolves triSurfaceMesh files relative to constant/geometry/
    // so keep the key as a simple file name (no slashes).
    city_buildings.stl
    {
        type triSurfaceMesh;
        name buildings; 
    }
}

castellatedMeshControls
{
    maxLocalCells 1000000;
    maxGlobalCells 2000000; // Safety limit
    minRefinementCells 10;
    maxLoadUnbalance 0.10;
    nCellsBetweenLevels 3;

    features
    (
        {
            // surfaceFeatures writes this alongside the STL in constant/geometry/
            file "city_buildings.eMesh";
            level 3;
        }
    );

    refinementSurfaces
    {
        buildings
        {
            level (3 4); // Refine mesh level 3 min, 4 max near buildings
            patchInfo
            {
                type wall;
            }
        }
    }

    resolveFeatureAngle 30;
    
    // IMPORTANT: Point inside the mesh but OUTSIDE the buildings
    // Adjust this coordinate to be in the air!
    locationInMesh (0 0 50); 

    allowFreeStandingZoneFaces true;
}

meshQualityControls
{
    maxNonOrtho         65;
    maxBoundarySkewness 20;
    maxInternalSkewness 4;
    maxConcave          80;
    minVol              1e-13;
    minTetQuality       1e-15;
    minArea             -1;
    minTwist            0.02;
    minDeterminant      0.001;
    minFaceWeight       0.02;
    minVolRatio         0.01;
    minTriangleTwist    -1;
    nSmoothScale        4;
    errorReduction      0.75;

    relaxed
    {
        maxNonOrtho 75;
    }
}

snapControls
{
    nSmoothPatch 3;
    tolerance 2.0;
    nSolveIter 30;
    nRelaxIter 5;

    nFeatureSnapIter 10;
    implicitFeatureSnap false;
    explicitFeatureSnap true;
    multiRegionFeatureSnap false;
}

addLayersControls
{
    relativeSizes true;
    layers
    {
        buildings
        {
            nSurfaceLayers 3; // 3 layers of cells hugging the building
        }
        ground
        {
            nSurfaceLayers 2;
        }
    }

    expansionRatio          1.2;
    finalLayerThickness     0.3;
    minThickness            0.1;
    nGrow                   0;

    featureAngle            60;
    slipFeatureAngle        30;

    nRelaxIter              5;
    nSmoothSurfaceNormals   1;
    nSmoothNormals          3;
    nSmoothThickness        10;

    maxFaceThicknessRatio   0.5;
    maxThicknessToMedialRatio 0.3;
    minMedianAxisAngle      90;

    nBufferCellsNoExtrude   0;
    nLayerIter              50;
}

mergeTolerance 1e-6;
